<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ZIP Highlight Map (Leaflet)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    #map { height: 90vh; }
    .controls { padding:8px; background: #fff; position: absolute; top:10px; left:10px; z-index:1000; border-radius:6px; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="controls">
    <label>输入要高亮的 5 位邮编（逗号分隔）：</label><br/>
    <input id="zipInput" style="width:220px" placeholder="e.g. 10001,94105" />
    <button id="applyBtn">高亮</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 初始化地图
    const map = L.map('map').setView([39.5, -98.35], 4); // USA center
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // 全局变量
    let zipLayer = null;
    let highlighted = new Set();

    // 加载 GeoJSON（注意：文件较大时可能慢）
    fetch('us_zcta_simplified.geojson')
      .then(r => r.json())
      .then(data => {
        // 样式函数：如果在 highlighted 集合中，用高亮色
        function style(feature) {
          const z = feature.properties.ZCTA5CE20 || feature.properties.ZCTA5; // 不同数据源字段名可能不同
          const isHi = highlighted.has(String(z).padStart(5,'0'));
          return {
            color: isHi ? '#ff3333' : '#666',
            weight: isHi ? 2.5 : 0.5,
            fillColor: isHi ? '#ffaaaa' : '#f2f2f2',
            fillOpacity: isHi ? 0.7 : 0.5
          };
        }

        function onEachFeature(feature, layer) {
          const z = feature.properties.ZCTA5CE20 || feature.properties.ZCTA5 || feature.properties.ZCTA5CE;
          layer.bindTooltip(String(z), {sticky:true});
        }

        zipLayer = L.geoJSON(data, { style, onEachFeature }).addTo(map);

        // 缩放到全部边界（可选）
        map.fitBounds(zipLayer.getBounds());
      });

    // 高亮控制
    document.getElementById('applyBtn').addEventListener('click', () => {
      const txt = document.getElementById('zipInput').value;
      const arr = txt.split(',').map(s => s.trim()).filter(s => s.length>0).map(s => String(s).padStart(5,'0'));
      highlighted = new Set(arr);
      if (zipLayer) {
        zipLayer.setStyle(function(feature){
          const z = feature.properties.ZCTA5CE20 || feature.properties.ZCTA5;
          const isHi = highlighted.has(String(z).padStart(5,'0'));
          return {
            color: isHi ? '#ff3333' : '#666',
            weight: isHi ? 2.5 : 0.5,
            fillColor: isHi ? '#ffaaaa' : '#f2f2f2',
            fillOpacity: isHi ? 0.7 : 0.5
          };
        });
        // 可选：把第一个高亮邮编 zoom 到可见
        if (arr.length>0) {
          let found = false;
          zipLayer.eachLayer(layer => {
            const z = layer.feature.properties.ZCTA5CE20 || layer.feature.properties.ZCTA5;
            if (String(z).padStart(5,'0') === arr[0]) {
              map.fitBounds(layer.getBounds(), { maxZoom: 13 });
              found = true;
            }
          });
          if (!found) alert('未找到邮编: ' + arr[0]);
        }
      }
    });
  </script>
</body>
</html>
